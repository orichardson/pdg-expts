\documentclass{article}

\usepackage{lmodern}
\input{pdg-preamble-v1}
\usepackage{enumitem}
\setlength\parskip{1ex}

% \newcommand\pts[1]{\mathop{\mathit{pts}} #1}
\newcommand\pts[1]{#1.\mathit{pts}}
\newcommand\R{\mathcal R}

\begin{document}
\section{Introduction}

We define a commitment machine

% \section{Preliminaries}


\section{Illustrations of Commitment}

\begin{example}
    Suppose you want to f
\end{example}


\section{Formalism}
The core idea is to provide a model in terms of two parts: a manifold $\Theta$
of configurations and a language $\Phi$.
% a manifold $\Theta$ and $\Phi$.
The elements of $\Theta$ are states: think parameters, probability distributions, data, assignements to program variables, and so forth.
Meanwhile, the elements of $\Phi$ are elements of elements

\begin{defn}
    A \emph{commitment function} is a function
    \[
        F: \Theta \times \Phi \times [0,1] \to \Theta,
    \]
    % whose application we will compress by writing $F^c_\phi\theta$ instead of $F(\theta, \phi, c)$,
    satisfying the following properties:
    \begin{enumerate}[nosep,label={CF\arabic*.}]
        \item $F$ is differentiable;
        % \item for all $\phi,\theta$, we have $F^0_\phi\theta = \theta$;
        \item for all $\phi$, the function $F^0_\phi : \Theta \to \Theta$ is the identity;
        \item for all $\phi$, the function $F^1_\phi : \Theta \to \Theta$ is idempotent.
    \end{enumerate}
\end{defn}



\begin{defn}
    A \emph{commitment system}
     % $(\Theta, \Phi, \chi)$.
    is a set of runs, each of which has a configuration $\theta(t)$
    and a commitment $\chi(\phi, t)$ in each proposition.

    Formally, a commitment system is a tuple
    % $(\chi, \theta)$
    $(\R, \Theta, \Phi, \chi, \theta, F)$,
    where
    \begin{itemize}[]
        \item $\R$ is a set of possible runs.
        % to each $r \in \R$ of which is a 1-dimensional differentiable manifold $T_r$ of times associated to $r$ (that is, ).
        % We write $(r,t) \in \R$ to refer to a run $r$ and a time $t \in T_r$.
        Let $\pts \R$ refer to the set of points $(r,t)$ such that $r \in \R$ and $t \in \mathbb R_{\ge 0}$.
        % and $t \in T_r$.
        % In most cases, we are interested in
        % Unless specified otherwise, we assume $T_r = \mathbb R_{\ge 0}$.
        \item $\Theta$ is a differentiable manifold of possible configurations.
        \item $\vartheta : \pts \R \to \Theta$ is a function that                describes the configuration $\vartheta(r,t)$ of the system at time $t$ in run $r$.
        \item
        % $\chi: (r: \R) \times T_r \times \Phi \to \mathbb R$
        $\chi: \pts \R \times \Phi \to [0,1]$
        is a convex relation between points of the system and language;
        the number $\chi(r, t, \phi) \in [0,1]$ represents the ``commitment'' of the system to the statement $\phi$ at time $t$ and run $r$.

        % \item
        %  $f: \Phi \to  \mathfrak X(\Theta)$ describes the dynamics of the system,
        %  by assigning a vector field $f_\phi : \Theta \to T\Theta$ to each sentence of the language.
        \item $F : \Theta \time \Phi \times [0,1] \to \Theta$ is a commitment function.
    \end{itemize}
    Furthermore, we require that the configurations and commitments be compatible with the dynmamics.
    This amounts to requiring that,
    for each $(r,t) \in \pts \R$,
        if $\chi(r,t,\phi) < 1$ for all $\phi \in \Phi$, then
    the configuration trajectory $t' \mapsto \vartheta(r,t')$ is continuously differentiable in $t'$ at $t'=t$, and
    \[
        \dot\vartheta(r,t) = \frac{\partial}{\partial t} \vartheta(r, t) =
            % \sum_{\phi \in \Phi} \chi(r,t,\phi) f(\phi)(\vartheta(r,t))
            % \sum_{\phi \in \Phi} -\log (1 - \chi(r,t,\phi)) f_\phi(\vartheta(r,t)).
            \sum_{\phi \in \Phi} -\log (1 - \chi(r,t,\phi)) F'_\phi(\vartheta(r,t)).
            % \int_{\Phi} f(\chi()) \mathrm d\phi
    \]
    % for each $(r,t) \in \pts \R$, and
    % \[
    %     \vartheta(r, t + \tau) =
    %     % \dot\vartheta(r,t) = \frac{\partial}{\partial t} \vartheta(r, t) =
    %     %     \sum_{\phi \in \Phi} -\log (1 - \chi(r,t,\phi)) f_\phi(\vartheta(r,t)).
    % \]
    Otherwise, if $\chi(r,t,\phi) = 1$, we require that
    $\displaystyle
        \lim_{\epsilon \to 0} \vartheta(r,t+\epsilon) =
            F^1_\phi(\vartheta(r,t))
    $.
    % the limit $\lim_{\epsilon \to 0} \vartheta(r,t+\epsilon)$ exists and is equal to
    % the
    % \[
    %     \lim_{\epsilon \to 0} \vartheta(r,t+\epsilon) =
    %     % \vartheta(r,t) +
    %     \lim_{\tau \to \infty}   \int_{}
    % \]

    % \begin{align*}
    %     \Big(
    %         \Omega,\quad
    %         \chi : \Omega \times T \times \Phi \to \mathbb R,\quad
    %         \theta : \Omega \times T \to \Theta, \quad
    %         F : \Phi \to \mathfrak X(\Theta)
    %     \Big)
    % \end{align*}
    Since $\Theta$, $\R,$ and $\Phi$ are implicit in the type signatures of $\theta$ and $\chi$, we can refer to the system without loss of precision as via the triple $(\theta, \chi, F)$.
\end{defn}

\begin{remark}
    \begin{enumerate}
        \item
        $(\Theta, F: \Theta \to \Theta^{})$ is a coalgebra for the signature $G_\Phi(-) := (-)^{\Phi \times [0,1]}$ of partial updates.
        \item $(\Phi, \iota : \mathrm{Exp} \Phi \to \Phi)$ is a algebra for the signature of expressions in the language $\Phi$.
    \end{enumerate}
\end{remark}


We now present two generic ways to describe a system: with an external supply of information, and by autonomous evolution.

\begin{defn}
    The \emph{controlled commitment system}
    $\mathit{ControlSys}(F)$
    generated by a commitment function $F$ is the set  of all possible trajectories of configurations and commitments that are compatible with $F$.
    Explicitly, $\R$ is given by
    \[
        \Big\{ (\theta_0, h) ~\Big|~  \theta_0 \in \Theta,~
            h : \Phi \times \mathbb R_{\ge 0} \to [0,1],~
             \Big\}
    \]
    so that $\pts \R = \R \times \mathbb R_{\ge 0}$,
    and then define
    $\chi((\theta_0,h,t),\phi) := h(\phi, t)$,
    and
    $\vartheta(\theta,h,-)$ to be the unique solution $\theta(t)$ to the ODE
    \[
        \theta(0) = \theta_0,
        \qquad \frac{\mathrm d\theta}{\mathrm d t} (t) =
            \sum_{\phi \in \Phi} h(\phi, t) F'_\phi(\theta(t)).
    \]
    % \begin{align*}
        % \varphi(\phi,t)
    % \end{align*}
\end{defn}

If we know something about the control signal $\chi = h$, we can also restrict to subsystems generated by only a subset of possible
control signals $h$. For instance, we can look at those runs where instructions are executed completely.

\begin{defn}
    The \emph{discretely controlled commitment system} generated by the commitment function $F$ is the subsystem of $\mathit{ControlSys}(F)$ in which the control signal $\chi$ either commits fully or not at all---that is,
    %
    the restriction of it to runs $r = (\theta_0, h)$ such that $h(\phi, t) \in \{0,1\}$
            for all $t \ge 0$ and $\phi \in \Phi$.
    % there exists some $\phi^* \in \Phi$ such that
    % the commitment $\chi(r,t,\phi) = \mathbbm 1[ \phi = \phi^*]$.
\end{defn}


%
% \begin{remark}
%     As a result
% \end{remark}


\begin{example}[probabilistic conditioning]
    Consider a measurable space $\mathcal X = (\Omega, \mathcal A)$ of outcomes.
    % , with a base measure $\lambda(X)$.
    Updating probabilistic by conditioning in response to new information may be described by a commitment system whose states $\Theta := \Delta \mathcal X$ are probability distributions, and whose language $\Phi = \mathcal A$ is the $\sigma$-algebra of events.

    Now, fix any commitment function such that $F(A,\mu,1) = \mu | A$, such as the linear one
    \[
        F(A, \mu, c) :=
         \begin{cases}
            (1-c) \mu + (c)\, \mu | A & \text{~if~} \mu(A) > 0 \\
            \mu & \text{~if~} \mu(A)=0
        \end{cases}
    \]
    Now, the discretely controlled commitment system generated by $F$ consists of all runs that begin with a distribution, receive events, and conditions on them.
\end{example}

\begin{example}
    Consider a finite automaton $(Q, \Sigma, \delta, \epsilon, \iota)$.

    The discretely controlled commitment system generated by
    \begin{align*}
        \Theta &:= \Delta Q &&
            \Phi := \Sigma
            \\
        F^c_{a}(q) &:= \mathrlap{
            \begin{cases}
                \delta_a(q) & \text{ if } c > 0 \\
                q & \text{ if } c = 0
            \end{cases}}
    \end{align*}
    consists of runs $\mathcal R$
\end{example}




\section{A Compilation Target}

\begin{center}
\tikzset{lang/.style={align=center,draw,outer sep=3pt}}
\begin{tikzcd}
    \node[lang] (pdg) {PDGs};
    \node[lang,below left=0 and 1 of pdg] (bn) {BNs};
    \node[lang,above left=0 and 1 of pdg] (fg) {FGs};
    \node[lang,below right=-0.1 and 1 of pdg] (opt) {Optimization\\Problems};
    \node[lang,below=1 of pdg] (ml) {Simple\\ML Systems};
    %
    \node[lang,below=0.5 of opt] (scs) {Stationary\\ Commitment\\ Systems};
    \node[lang,above right=-0.2 and 1 of scs] (acs) {Autonomous\\ Commitment\\ Systems};
    \node[lang,below=1 of acs] (ccs) {Control\\ Commitment\\ Systems};
    %
    \draw[right hook->]
        (bn) edge (fg)
        (fg) edge (pdg)
        (bn) edge (pdg)
        (pdg) edge (opt)
        (pdg) edge (ml)
        (ml) edge (opt)
        (scs) edge (acs)
        (scs) edge (ccs);
    \draw[double] (opt) edge (scs);
    %
\end{tikzcd}
\end{center}

\subsection{PDGs as Commitment Systems}

\subsection{ML Systems as Commitment Systems}
If we squint, an ML system can be seen as an optimization problem, and hence a stationary commitment system.

\begin{example}[Gradient Flow System]
    Consider a parameterized statistical model of some variable $Y$ that takes a variable $X$ as input.

\end{example}


% \begin{example}[factor graphs as commitment systems]
%     Consider a factor graph
%     % with factors $f_1(X_1), \ldots, f_n(X_n)$.
%     $\{ f_j(\mat X_j) \}_{j \in J}$ over variables $\mathcal X = \cup_{j \in J} \mat X_j$.
%     The corresponding system has a run for all positive probability distributions $\mu_0 \in \Delta^{\!\!{+}\!} \mathcal X$, in which $\mu$ approaches the optimal proability, which is the solution to the ODE
%     \begin{align*}
%         \theta(0) = \mu_0;
%             \qquad
%         \dot\theta(t) = 
%     \end{align*}
%     So, in all, we have
%     % \[
%     %     \mathccal R
%     % \]
% \end{example}

\clearpage
\appendix
\section{}
\subsection{Convex Relations}
Let $\mat A = \{ A_1, \ldots, A_n \}$ be a set of sets, which we will call attributes.
A convex relation $R(\mat A)$, or simply $R$,  is a function
    $R : \prod_{i=1}^n A_i \to [0,1]$.
There are two two extremal relations, the zero relation and the one relation.
Suppose $R$ and $S$ are convex relations over the same attributes $\mat A$. We can form new relations in a number of ways.
% First, here are some
\begin{itemize}
    \item \textbf{convex combination.} For $\alpha \in [0,1]$, we get a convex relation $(R : \alpha : S)(\mat A) := (1-\alpha) R(\mat A) + \alpha S(\mat A)$.
    % \item \textbf{.} More generally, if $\cal R = \{ R_1, \ldots, R_n\}$ is a set of convex relations with each $R_i \in \square A$ over the same attributes $A$, and $M : \R \to [0,1]$ is a convex relation on that set of relations, then
    % \[
    %     \R ^{M} (A) := \sum_{i=1}^n R_i(A) M(R_i)
    % \]
    \item \textbf{warping.} For $\gamma \ge 0$,  $R^\gamma(\mat A)$ is also a relation on $\mat A$.
    \item \textbf{multiplication.} $(R \cdot S)(\mat A) := R(\mat A) \cdot S(\mat A)$.
    \item \textbf{max.} $(R \land S)(\mat A) := \max \{ R(\mat A),  S(\mat A) \}$.
    \item \textbf{axis normalization.} for a subset $\mat B \subseteq \mat A$ of attributes, we can define ...

    \TODO

    % \begin{enumerate}
    %     \item \textit{(sum)}
    %     \[
    %         R[\mat B] :=
    %     \]
    % \end{enumerate}
\end{itemize}

Let $\square \mat A$ denote the set of all convex relations on attributes $\mat A$.

% Here are some examples of convex relations.
% Lots of things can be represented as convex relations; here are a few.
We now detail some special cases.
\begin{enumerate}
    \item an ``ordinary'' relation $R(\mat A)$
    % is a subset of
        % $A_1 \times \cdots\times A_n$, or a function
        % $R : \prod_{i=1}^n A_i \to \{0,1\}$.
        can be viewed as the special case of a convex relation whose output is always zero or one, and not anything in between.
    \item a probability distribution $p(X)$ can be viewed as a convex relation on one attribute: the values $\V X$ that $X$ can take, with the special property that
    $\sum_{x \in \V X}p(X) = 1$.
\end{enumerate}

\begin{remark}
    % Some facts.
    \begin{enumerate}
        \item ordinary relations are invariant under warping.
        \item the convex relations that are both ordinary relations and probability distributions are deterministic distributions.
        % \item
    \end{enumerate}
\end{remark}

% \textbf{Operations on convex relations}
\begin{defn}

\end{defn}

\end{document}
